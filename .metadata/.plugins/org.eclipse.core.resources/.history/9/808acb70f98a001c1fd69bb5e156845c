package com.abhisek.mindtree.service;

import java.util.List;
import java.util.stream.Collectors;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.PageRequest;
import org.springframework.data.domain.Pageable;
import org.springframework.stereotype.Service;

import com.abhisek.mindtree.dto.ProductRequest;
import com.abhisek.mindtree.dto.ProductResponseDto;
import com.abhisek.mindtree.model.Apparel;
import com.abhisek.mindtree.model.Book;
import com.abhisek.mindtree.model.Product;
import com.abhisek.mindtree.repository.ApparelRepository;
import com.abhisek.mindtree.repository.BookRepository;
import com.abhisek.mindtree.repository.ProductRepository;
import com.fasterxml.jackson.core.JsonProcessingException;
import com.fasterxml.jackson.core.type.TypeReference;
import com.fasterxml.jackson.databind.JsonMappingException;
import com.fasterxml.jackson.databind.ObjectMapper;

@Service
public class ProductService {

	@Autowired
	private BookRepository bookRepository;

	@Autowired
	private ApparelRepository apparelRepository;

	@Autowired
	private ProductRepository productRepository;

	public String saveProduct(List<ProductRequest> productRequests) {

		ObjectMapper mapper = new ObjectMapper();

		List<ProductRequest> booksList = productRequests.stream().filter(b -> b.getGenre() != null)
				.collect(Collectors.toList());
		List<ProductRequest> apparelsList = productRequests.stream().filter(b -> b.getBrand() != null)
				.collect(Collectors.toList());

		String jsonBooks = null;
		String jsonApparels = null;
		try {
			jsonBooks = mapper.writeValueAsString(booksList);
			jsonApparels = mapper.writeValueAsString(apparelsList);
		} catch (JsonProcessingException e) {
			// TODO Auto-generated catch block
			e.printStackTrace();
		}
		List<Book> booksObject = null;
		List<Apparel> apparelsObject = null;
		try {
			booksObject = mapper.readValue(jsonBooks, new TypeReference<List<Book>>() {
			});
			apparelsObject = mapper.readValue(jsonApparels, new TypeReference<List<Apparel>>() {
			});
		} catch (JsonMappingException e) {
			// TODO Auto-generated catch block
			e.printStackTrace();
		} catch (JsonProcessingException e) {
			// TODO Auto-generated catch block
			e.printStackTrace();
		}
		bookRepository.saveAll(booksObject);
		apparelRepository.saveAll(apparelsObject);

		return "Success";

	}

	public String deleteProduct(int id) {

		productRepository.deleteById(id);
		return "Success";

	}

	public ProductResponseDto getProductsByCategory(String category,int pageNumber, int pageSize) {
		Pageable pageable = PageRequest.of(pageNumber - 1, pageSize);
		Page<Product> contentPage = productRepository.findByDtype(category,pageable);
		List<Product> restaurantsToReturn = contentPage.getContent();
		return new ProductResponseDto(restaurantsToReturn, contentPage.getTotalPages(),
				contentPage.getTotalElements());

	}

	public Product getProductsByName(String name) {

		Product response = productRepository.findByProductName(name);
		return response;
	}

}
